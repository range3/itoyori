x-common: &x-common
  build:
    context: .
    dockerfile: Dockerfile
  init: true
  environment:
    MPI_HOSTS: h1,h2,h3,h4
  volumes:
    - ..:/workspaces/itoyori:cached
    - spack-root:/home/vscode/.cache/spack
    - spack-settings:/home/vscode/.spack
  networks:
    - itoyori_net
  cap_add:
    - SYS_PTRACE
  security_opt:
    - seccomp:unconfined
  privileged: true
  command: >
    bash -c "sudo service ssh restart && sleep infinity"

services:
  h1:
    <<: *x-common
    hostname: h1
    container_name: itoyori-h1
  h2:
    <<: *x-common
    hostname: h2
    container_name: itoyori-h2
  h3:
    <<: *x-common
    hostname: h3
    container_name: itoyori-h3
  h4:
    <<: *x-common
    hostname: h4
    container_name: itoyori-h4

networks:
  itoyori_net:

volumes:
  spack-root:
  spack-settings:
